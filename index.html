<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fuzzy QA Platform</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Async load backend base (keep your original logic) -->
  <script>
  (async () => {
    const r = await fetch('./config.json', { cache: 'no-store' });
    const cfg = await r.json();
    window.BACKEND_BASE = cfg.BACKEND_BASE;
  })();
  </script>

  <script defer src="config.js"></script>
  <script defer src="app.js"></script>
  <!-- Note: this script must run after app.js to override its authHeaders -->
  <script defer>
  (function () {
    function setUser(u){
      localStorage.setItem('username', u);
      var el = document.getElementById('uname');
      if (el) el.textContent = u || '(Not set)';
      var btn1 = document.getElementById('btn-load');
      var btn2 = document.getElementById('btn-submit');
      if (btn1) btn1.disabled = !u;
      if (btn2) btn2.disabled = !u;
    }

    // 统一从本地读取“已有的用户名”（优先 localStorage，也兼容常见键名与 cookie）
    function getLocalUsername() {
      var u =
        localStorage.getItem('username') ||
        localStorage.getItem('user') ||
        localStorage.getItem('uname') ||
        '';
      if (!u) {
        // 尝试从 cookie 兜底（如有其他页面写入了 cookie）
        var m = document.cookie.match(/(?:^|;)\s*username=([^;]+)/);
        if (m) u = decodeURIComponent(m[1]);
      }
      return (u || '').trim();
    }

    // 支持传入默认值（用于 Switch User 的初始值）
    function ask(defaultName){
      var u = (prompt('Please enter your username:', defaultName || '') || '').trim();
      if (u) setUser(u);
    }

    // Init：平台最开始“读取本地的 username”
    var saved = getLocalUsername();
    if (saved) {
      setUser(saved);
      // 记录“本会话初始用户名”为本地已有值
      sessionStorage.setItem('username_initial', saved);
    } else {
      // 本地没有就询问一次，并把第一次输入视为会话初始
      ask('');
      var now = localStorage.getItem('username') || '';
      if (now) sessionStorage.setItem('username_initial', now);
    }

    // 绑定 Switch User：初始值为“开始登录网站时”的本地用户名；用户仍可改为公户等
    document.addEventListener('DOMContentLoaded', function(){
      var sw = document.getElementById('btn-switch-user');
      if (sw) sw.addEventListener('click', function(){
        var firstLogin = sessionStorage.getItem('username_initial') || getLocalUsername() || '';
        ask(firstLogin);
      });
    });

    // 覆盖 app.js 的 authHeaders，始终附带 X-Username
    var orig = window.authHeaders;
    window.authHeaders = function(){
      var h = orig ? orig() : { "Content-Type": "application/json" };
      var u = localStorage.getItem('username') || '';
      if (u) h['X-Username'] = u;
      return h;
    };
  })();
  </script>
</head>

<!-- Scoring hint (always visible) -->
<div id="scoring-hint" class="card" role="note" aria-live="polite" style="
  margin: 12px 0;
  padding: 10px 12px;
  border-left: 4px solid #040003;
  background: #ffffff;
  font-size: 14px;
  line-height: 1.5;
  color: #000000;
">
  <b>Scoring reminder:</b>
  <span>test model <u>wrong</u> = <b>+1</b>; <u>correct</u> = <b>0</b>; <u>unreasonable question</u> (no definite answer / relies on non-visible info) = <b>-1</b>.</span>
</div>

<body>
  <header>
    <h1>Fuzzy QA Platform</h1>

    <!-- User bar (show current user & switch) -->
    <div id="userbar" class="card" style="display:flex;gap:8px;align-items:center;">
      <span>Current User: <b id="uname">(Not set)</b></span>
      <button id="btn-switch-user" type="button">Switch User</button>
    </div>

    <button id="btn-load" disabled>Load Random Sample</button>
  </header>

  <main>
    <section id="image-section" class="card hidden">
      <img id="img" alt="sample" />
      <div class="meta">
        <div>Sample ID: <code id="sample-id">—</code></div>
        <div>Image: <code id="image-rel">—</code></div>
      </div>
    </section>
    <section id="qa-section" class="card hidden">
      <table id="qa-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Dimension</th>
            <th>Question</th>
            <th>Test Model Answer</th>
            <th>Rating (-1/0/+1)</th>
            <th>Comment</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="actions">
        <button id="btn-submit" disabled>Submit Ratings</button>
      </div>
      <div id="toast" class="toast hidden"></div>
    </section>
  </main>
</body>
</html>
